@inject IChapterService ChapterService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<MudCard Elevation="3" Class="chapter-locked-card">
    <MudCardContent Class="pa-6">
        <!-- Header con ícono de candado -->
        <div class="d-flex align-center mb-4">
            <MudIcon Icon="@Icons.Material.Filled.Lock" Color="Color.Warning" Size="Size.Medium" Class="mr-3" />
            <div>
                <MudText Typo="Typo.h6">
                    @Chapter.Title
                </MudText>
                <MudText Typo="Typo.caption">
                    Capítulo @Chapter.ChapterNumber
                </MudText>
            </div>
        </div>

        <!-- Mensaje de capítulo bloqueado -->
        <MudAlert NoIcon="false" Class="mb-4"
            Style="background-color: rgb(230, 230, 230); border-left: 4px solid black;">
            <MudText Typo="Typo.body2">
                <strong>Capítulo Premium</strong>
            </MudText>
            <MudText Typo="Typo.caption">
                Este capítulo requiere compra para poder ser leído
            </MudText>
        </MudAlert>

        <!-- Información del precio -->
        <MudPaper Elevation="1" Class="pa-3 mb-4" Style="">
            <div class="d-flex justify-space-between align-center">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.MonetizationOn" Color="Color.Warning" Size="Size.Small"
                        Class="mr-2" />
                    <MudText Typo="Typo.subtitle1">
                        <strong>@Chapter.PriceMythras Mythras</strong>
                    </MudText>
                </div>
                <MudChip T="string" Size="Size.Medium" Variant="Variant.Text" Color="Color.Dark"
                    Icon="@Icons.Material.Filled.Schedule">
                    Publicado @Chapter.CreatedAt.ToString("dd/MM/yyyy")
                </MudChip>
            </div>
        </MudPaper>

        <!-- Botón de comprar -->
        <div class="text-center">
            <MudButton Variant="Variant.Filled" Color="Color.Dark" Size="Size.Large"
                StartIcon="@Icons.Material.Filled.ShoppingCart" FullWidth="true" Class="purchase-button"
                OnClick="@HandleSubmit">
                Comprar Capítulo
            </MudButton>
        </div>

        <!-- Información adicional -->
        <MudDivider Class="my-3" />
        <MudText Typo="Typo.caption" Align="Align.Center">
            Una vez comprado, tendrás acceso permanente a este capítulo
        </MudText>
    </MudCardContent>
</MudCard>

<style>
    .chapter-locked-card {
        margin: 0 auto;
    }

    .purchase-button {
        font-weight: 600;
        text-transform: none;
        border-radius: 8px;
        padding: 12px 24px;
        box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
        transition: all 0.3s ease;
    }

    .purchase-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(156, 39, 176, 0.4);
    }
</style>

@code {
    [Parameter] public ChapterModel Chapter { get; set; } = new();

    public async Task HandleSubmit()
    {
        try
        {
            var result = await ChapterService.PurchaseChapterAsync(Chapter.Id, Chapter.PriceMythras);

            if (result.Success)
            {
                Snackbar.Add("Felicidades, su compra ah sido procesada con exito", Severity.Success);
                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
            else
            {
                Snackbar.Add(result.Message, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error al comprar capitulo: " + ex.Message);
            Snackbar.Add("Lo sentimos, ocurrio un error con el servidor, por favor intentelo más tarde", Severity.Error);
        }
    }
}